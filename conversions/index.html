


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.0">
    
    
      
        <title>Conversions - Apischema</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b5d04df8.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.9ab2c1f8.min.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="green" data-md-color-accent="indigo">
  
    
      <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#conversions-deserialization-customization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Apischema" class="md-header-nav__button md-logo" aria-label="Apischema">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Apischema
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Conversions
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/wyfo/apischema/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    wyfo/apischema
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Apischema" class="md-nav__button md-logo" aria-label="Apischema">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Apischema
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/wyfo/apischema/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    wyfo/apischema
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../data_model/" title="Data model" class="md-nav__link">
      Data model
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../de_serialization/" title="(De)serialization" class="md-nav__link">
      (De)serialization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../json_schema/" title="JSON schema" class="md-nav__link">
      JSON schema
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../validation/" title="Validation" class="md-nav__link">
      Validation
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Conversions
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Conversions" class="md-nav__link md-nav__link--active">
      Conversions
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#principle-apischema-conversions" class="md-nav__link">
    Principle - apischema conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-a-conversion" class="md-nav__link">
    Register a conversion
  </a>
  
    <nav class="md-nav" aria-label="Register a conversion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiple-deserializers" class="md-nav__link">
    Multiple deserializers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheritance" class="md-nav__link">
    Inheritance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-conversions" class="md-nav__link">
    Generic conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-object" class="md-nav__link">
    Conversion object
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-conversions-select-conversions-at-runtime" class="md-nav__link">
    Dynamic conversions — select conversions at runtime
  </a>
  
    <nav class="md-nav" aria-label="Dynamic conversions — select conversions at runtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-conversions-are-local" class="md-nav__link">
    Dynamic conversions are local
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-conversions-interact-with-schema_ref" class="md-nav__link">
    Dynamic conversions interact with schema_ref
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-registered-conversion" class="md-nav__link">
    Bypass registered conversion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#liskov-substitution-principle" class="md-nav__link">
    Liskov substitution principle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generic-dynamic-conversions" class="md-nav__link">
    Generic dynamic conversions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-conversions" class="md-nav__link">
    Field conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serialized-method-conversions" class="md-nav__link">
    Serialized method conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataclass-model-automatic-conversion-fromto-dataclass" class="md-nav__link">
    Dataclass model - automatic conversion from/to dataclass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-parameters-as-dataclass" class="md-nav__link">
    Function parameters as dataclass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#default-conversions" class="md-nav__link">
    Default conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sub-conversions" class="md-nav__link">
    Sub-conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyrecursive-conversions" class="md-nav__link">
    Lazy/recursive conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-conversion-can-only-be-applied-on-classes" class="md-nav__link">
    Why conversion can only be applied on classes?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-dynamic-conversion-cannot-apply-on-the-whole-data-model" class="md-nav__link">
    Why dynamic conversion cannot apply on the whole data model?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      GraphQL
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="GraphQL" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        GraphQL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../graphql/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../graphql/data_model_and_resolvers/" title="Data model and resolvers" class="md-nav__link">
      Data model and resolvers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../graphql/schema/" title="GraphQL schema" class="md-nav__link">
      GraphQL schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../graphql/relay/" title="Relay" class="md-nav__link">
      Relay
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Examples
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Examples" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/open_rpc/" title="OpenRPC" class="md-nav__link">
      OpenRPC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/sqlalchemy_support/" title="SQLAlchemy support" class="md-nav__link">
      SQLAlchemy support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/pydantic_support/" title="Pydantic support" class="md-nav__link">
      Pydantic support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/attrs_support/" title="Attrs support" class="md-nav__link">
      Attrs support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/subclasses_union/" title="Class as union of its subclasses" class="md-nav__link">
      Class as union of its subclasses
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../examples/recoverable_fields/" title="Recoverable fields" class="md-nav__link">
      Recoverable fields
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../benchmark/" title="Benchmark" class="md-nav__link">
      Benchmark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../difference_with_pydantic/" title="Difference with pydantic" class="md-nav__link">
      Difference with pydantic
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/wyfo/apischema/releases" title="Releases" class="md-nav__link">
      Releases
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#principle-apischema-conversions" class="md-nav__link">
    Principle - apischema conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-a-conversion" class="md-nav__link">
    Register a conversion
  </a>
  
    <nav class="md-nav" aria-label="Register a conversion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiple-deserializers" class="md-nav__link">
    Multiple deserializers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheritance" class="md-nav__link">
    Inheritance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-conversions" class="md-nav__link">
    Generic conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-object" class="md-nav__link">
    Conversion object
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-conversions-select-conversions-at-runtime" class="md-nav__link">
    Dynamic conversions — select conversions at runtime
  </a>
  
    <nav class="md-nav" aria-label="Dynamic conversions — select conversions at runtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-conversions-are-local" class="md-nav__link">
    Dynamic conversions are local
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-conversions-interact-with-schema_ref" class="md-nav__link">
    Dynamic conversions interact with schema_ref
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-registered-conversion" class="md-nav__link">
    Bypass registered conversion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#liskov-substitution-principle" class="md-nav__link">
    Liskov substitution principle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generic-dynamic-conversions" class="md-nav__link">
    Generic dynamic conversions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-conversions" class="md-nav__link">
    Field conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serialized-method-conversions" class="md-nav__link">
    Serialized method conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataclass-model-automatic-conversion-fromto-dataclass" class="md-nav__link">
    Dataclass model - automatic conversion from/to dataclass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-parameters-as-dataclass" class="md-nav__link">
    Function parameters as dataclass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#default-conversions" class="md-nav__link">
    Default conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sub-conversions" class="md-nav__link">
    Sub-conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyrecursive-conversions" class="md-nav__link">
    Lazy/recursive conversions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-conversion-can-only-be-applied-on-classes" class="md-nav__link">
    Why conversion can only be applied on classes?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-dynamic-conversion-cannot-apply-on-the-whole-data-model" class="md-nav__link">
    Why dynamic conversion cannot apply on the whole data model?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/wyfo/apischema/edit/master/docs/conversions.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="conversions-deserialization-customization">Conversions – (de)serialization customization<a class="headerlink" href="#conversions-deserialization-customization" title="Permanent link">&para;</a></h1>
<p><em>apischema</em> covers majority of standard data types, but it's of course not enough, that's why it gives you the way to add support for all your classes and the libraries you use.</p>
<p>Actually, <em>apischema</em> uses internally its own feature to support standard library data types like UUID/datetime/etc. (see <a href="https://github.com/wyfo/apischema/blob/master/apischema/std_types.py">std_types.py</a>)</p>
<p>ORM support can easily be achieved with this feature (see <a href="../examples/sqlalchemy_support/">SQLAlchemy example</a>).</p>
<p>In fact, you can even add support of competitor libraries like <em>Pydantic</em> (see <a href="../examples/pydantic_support/"><em>Pydantic</em> compatibility example</a>)</p>
<h2 id="principle-apischema-conversions">Principle - apischema conversions<a class="headerlink" href="#principle-apischema-conversions" title="Permanent link">&para;</a></h2>
<p>An <em>apischema</em> conversion is composed of a source type, let's call it <code>Source</code>, a target type <code>Target</code> and a converter function of signature <code>(Source) -&gt; Target</code>.</p>
<p>When a class (actually, a non-builtin class, so not <code>int</code>/<code>list</code>/etc.) is deserialized, <em>apischema</em> will look if there is a conversion where this type is the target. If found, the source type of conversion will be deserialized, then the converter will be applied to get an object of the expected type. Serialization works the same (inverted) way: look for a conversion with type as source, apply then converter, and get the target type.</p>
<p>Conversion can only be applied on classes, not other types like <code>NewType</code>, etc. (see <a href="#why-dynamic-conversion-cannot-apply-on-the-whole-data-model">FAQ</a>)</p>
<p>Conversions are also handled in schema generation: for a deserialization schema, source schema is merged to target schema, while target schema is merged to source schema for a serialization schema.</p>
<h2 id="register-a-conversion">Register a conversion<a class="headerlink" href="#register-a-conversion" title="Permanent link">&para;</a></h2>
<p>Conversion is registered using <code>apischema.deserializer</code>/<code>apischema.serializer</code> for deserialization/serialization respectively.</p>
<p>When used as function decorator, the <code>Source</code>/<code>Target</code> types are directly extracted from conversion function signature. </p>
<p><code>serializer</code> can be called on methods/properties, in which case <code>Source</code> type is inferred to be th owning type.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">deserializer</span><span class="p">,</span> <span class="n">serializer</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">deserialization_schema</span><span class="p">,</span> <span class="n">serialization_schema</span>


<span class="nd">@schema</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RGB</span><span class="p">:</span>
    <span class="n">red</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">green</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">blue</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@serializer</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hexa</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">red</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">green</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">blue</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># serializer can also be called with methods/properties outside of the class</span>
<span class="c1"># For example, `serializer(RGB.hexa)` would have the same effect as the decorator above</span>


<span class="nd">@deserializer</span>
<span class="k">def</span> <span class="nf">from_hexa</span><span class="p">(</span><span class="n">hexa</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RGB</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">RGB</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hexa</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hexa</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">hexa</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>


<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">RGB</span><span class="p">,</span> <span class="s2">&quot;#000000&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;#00002a&quot;</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">deserialization_schema</span><span class="p">(</span><span class="n">RGB</span><span class="p">)</span>
    <span class="o">==</span> <span class="n">serialization_schema</span><span class="p">(</span><span class="n">RGB</span><span class="p">)</span>
    <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^#[0-9a-fA-F]</span><span class="si">{6}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>(De)serializer methods cannot be used with <code>typing.NamedTuple</code>; in fact, <em>apischema</em> uses <code>__set_name__</code> magic method but it is not called on <code>NamedTuple</code> subclass fields. </p>
</div>
<h3 id="multiple-deserializers">Multiple deserializers<a class="headerlink" href="#multiple-deserializers" title="Permanent link">&para;</a></h3>
<p>Sometimes, you want to have several possibilities to deserialize a type. If it's possible to register a deserializer with an <code>Union</code> param, it's not very practical. That's why <em>apischema</em> make it possible to register several deserializers for the same type. They will be handled with an <code>Union</code> source type (ordered by deserializers registration), with the right serializer selected according to the matching alternative.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">deserializer</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">deserialization_schema</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Expression</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@deserializer</span>
<span class="k">def</span> <span class="nf">evaluate_expression</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">)))</span>


<span class="c1"># Could be shorten into deserializer(Expression), because class is callable too</span>
<span class="nd">@deserializer</span>
<span class="k">def</span> <span class="nf">expression_from_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">assert</span> <span class="n">deserialization_schema</span><span class="p">(</span><span class="n">Expression</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;integer&quot;</span><span class="p">],</span>
<span class="p">}</span>
<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="s2">&quot;1 - 1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Expression</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<p>On the other hand, serializer registration overwrite the previous registration if any. </p>
<p><code>apischema.conversions.reset_deserializers</code>/<code>apischema.conversions.reset_serializers</code> can be used to reset (de)serializers (even those of the standard types embedded in <em>apischema</em>)</p>
<h3 id="inheritance">Inheritance<a class="headerlink" href="#inheritance" title="Permanent link">&para;</a></h3>
<p>All serializers are naturally inherited. In fact, with a conversion function <code>(Source) -&gt; Target</code>, you can always pass a subtype of <code>Source</code> and get a <code>Target</code> in return.</p>
<p>Moreover, when serializer is a method/property, overriding this method/property in a subclass will override the inherited serializer.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">serializer</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="nd">@serializer</span>
<span class="k">def</span> <span class="nf">serialize_foo</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">Foo2</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># Deserializer is inherited</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span> <span class="o">==</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo2</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="nd">@serializer</span>
    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">Bar2</span><span class="p">(</span><span class="n">Bar</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>


<span class="c1"># Deserializer is inherited and overridden</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Bar</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Bar2</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>On the other hand, deserializers cannot be inherited, because the same <code>Source</code> passed to a conversion function <code>(Source) -&gt; Target</code> will always give the same <code>Target</code> (not ensured to be the desired subtype).</p>
<p>However, there is one way to do it by using a <code>classmethod</code> and the special decorator <code>apischema.conversions.inherited_deserializer</code>; the class parameter of the method is then assumed to be used to instantiate the return.  </p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">inherited_deserializer</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>

    <span class="nd">@inherited_deserializer</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_int</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">Bar</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An "other" way to achieve that would be to use <code>__init_subclass__</code> method in order to add a deserializer to each subclass. In fact, that's what <code>inherited_deserializer</code> is doing behind the scene.</p>
</div>
<h2 id="generic-conversions">Generic conversions<a class="headerlink" href="#generic-conversions" title="Permanent link">&para;</a></h2>
<p><code>Generic</code> conversions are supported out of the box.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">raises</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">deserializer</span><span class="p">,</span> <span class="n">serializer</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">deserialization_schema</span><span class="p">,</span> <span class="n">serialization_schema</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Wrapper</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="n">wrapped</span>

    <span class="c1"># serializer decorator for methods of generic class is not supported in Python 3.6</span>
    <span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span>


<span class="c1"># Wrapper constructor can be used as a function too</span>
<span class="n">deserializer</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span>
<span class="n">serializer</span><span class="p">(</span><span class="n">Wrapper</span><span class="o">.</span><span class="n">unwrap</span><span class="p">)</span>


<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">with</span> <span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
    <span class="n">deserialize</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;wrapped&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">(</span><span class="s2">&quot;wrapped&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;wrapped&quot;</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">deserialization_schema</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}</span>
    <span class="o">==</span> <span class="n">serialization_schema</span><span class="p">(</span><span class="n">Wrapper</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
<span class="p">)</span>
</code></pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>(De)serializer cannot decorate methods of <code>Generic</code> classes in Python 3.6, it has to be used outside of class.</p>
</div>
<p>However, it's not allowed to register a conversion of a specialized generic type, like <code>Foo[int]</code>(see <a href="#why-conversion-can-only-be-applied-on-classes-and-not-on-others-types-newtype-fooint-etc">FAQ</a>).</p>
<h2 id="conversion-object">Conversion object<a class="headerlink" href="#conversion-object" title="Permanent link">&para;</a></h2>
<p>In previous example, conversions where registered using only converter functions. However, everywhere you can pass a converter, you can also pass a <code>apischema.conversions.Conversion</code> instance.
<code>Conversion</code> allows adding additional metadata to conversion than a function can do ; it can also be used to precise converter source/target when annotations are not available.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">deserializer</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span>

<span class="n">deserializer</span><span class="p">(</span><span class="n">Conversion</span><span class="p">(</span><span class="n">b64decode</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="nb">bytes</span><span class="p">))</span>
<span class="c1"># Roughly equivalent to:</span>
<span class="c1"># def decode_bytes(source: str) -&gt; bytes:</span>
<span class="c1">#     return b64decode(source)</span>
<span class="c1"># but saving a function call</span>

<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="s2">&quot;Zm9v&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;foo&quot;</span>
</code></pre></div>

<h2 id="dynamic-conversions-select-conversions-at-runtime">Dynamic conversions — select conversions at runtime<a class="headerlink" href="#dynamic-conversions-select-conversions-at-runtime" title="Permanent link">&para;</a></h2>
<p>No matter if a conversion is registered or not for a given type, conversions can also be provided at runtime, using <code>conversions</code> parameter of <code>deserialize</code>/<code>serialize</code>/<code>deserialization_schema</code>/<code>serialization_schema</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span>

<span class="c1"># Set UTC timezone for example</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
<span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">datetime_from_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>


<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="mi">1504310400</span><span class="p">,</span> <span class="n">conversions</span><span class="o">=</span><span class="n">datetime_from_timestamp</span><span class="p">)</span> <span class="o">==</span> <span class="n">date</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">baz</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baz</span><span class="p">)</span>


<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">Foo</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">Foo</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <code>definitions_schema</code>, conversions can be added with types by using a tuple instead, for example <code>definitions_schema(serializations=[(list[Foo], foo_to_bar)])</code>. </p>
</div>
<p><code>conversions</code> parameter can also take a list of conversions, when you have a <code>Union</code>, a <code>tuple</code> or when you want to have several deserializations for the same type</p>
<h3 id="dynamic-conversions-are-local">Dynamic conversions are local<a class="headerlink" href="#dynamic-conversions-are-local" title="Permanent link">&para;</a></h3>
<p>Dynamic conversions are discarded after having been applied (or after class without conversion having been encountered). For example, you can't apply directly a dynamic conversion to a dataclass field when calling  <code>serialize</code> on an instance of this dataclass. Reasons of this design are detailed in the <a href="#why-dynamic-conversion-cannot-apply-on-the-whole-data-model">FAQ</a>. </p>
<p>However, there is an exception for containers like <code>Collection</code>, <code>list</code>, <code>dict</code>, etc. and <code>Union</code>, and types with a registered conversion from/to a container: dynamic conversions are not discarded and can be used by their elements </p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span>

<span class="c1"># Set UTC timezone for example</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
<span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span> <span class="n">datetime</span>


<span class="c1"># timestamp conversion is not applied on Foo field because it&#39;s discarded</span>
<span class="c1"># when encountering Foo</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">)),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">to_timestamp</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-10-13T00:00:00&quot;</span>
<span class="p">}</span>

<span class="c1"># timestamp conversion is applied on every member of list</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">conversions</span><span class="o">=</span><span class="n">to_timestamp</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<h3 id="dynamic-conversions-interact-with-schema_ref">Dynamic conversions interact with <code>schema_ref</code><a class="headerlink" href="#dynamic-conversions-interact-with-schema_ref" title="Permanent link">&para;</a></h3>
<p>Dynamic conversions are applied before looking for a ref registered with <code>schema_ref</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">schema_ref</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">serialization_schema</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">foo_to_bar</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">Foo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bar</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Bar</span><span class="p">()</span>


<span class="n">schema_ref</span><span class="p">(</span><span class="s2">&quot;Bars&quot;</span><span class="p">)(</span><span class="nb">list</span><span class="p">[</span><span class="n">Bar</span><span class="p">])</span>

<span class="k">assert</span> <span class="n">serialization_schema</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="n">Foo</span><span class="p">],</span> <span class="n">all_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conversions</span><span class="o">=</span><span class="n">foo_to_bar</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/$defs/Bars&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$defs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># Bars is present because `list[Foo]` is dynamically converted to `list[Bar]`</span>
        <span class="s2">&quot;Bars&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/$defs/Bar&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;Bar&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="bypass-registered-conversion">Bypass registered conversion<a class="headerlink" href="#bypass-registered-conversion" title="Permanent link">&para;</a></h3>
<p>Dynamic conversions can be used to bypass a registered conversion, i.e. to (de)serialize the given type as it would be without conversion registered. It requires to use a <code>Conversion</code> object with an <code>apischema.conversions.identity</code> converter, and the same source type as the target type.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">serializer</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">identity</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RGB</span><span class="p">:</span>
    <span class="n">red</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">green</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">blue</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@serializer</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hexa</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">red</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">green</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">blue</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;#000000&quot;</span>
<span class="c1"># dynamic conversion used to bypass the registered one</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span>
    <span class="n">RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">Conversion</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">RGB</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">RGB</span><span class="p">)</span>
<span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</code></pre></div>

<h3 id="liskov-substitution-principle">Liskov substitution principle<a class="headerlink" href="#liskov-substitution-principle" title="Permanent link">&para;</a></h3>
<p>LSP is taken in account when applying dynamic conversion: serializer source can be a subclass of the actual class and deserializer target can be a superclass of the actual class.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">field</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
    <span class="n">other</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span> <span class="nf">foo_to_int</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">foo</span><span class="o">.</span><span class="n">field</span>


<span class="k">def</span> <span class="nf">bar_from_int</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bar</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">foo_to_int</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conversions</span><span class="o">=</span><span class="n">bar_from_int</span><span class="p">)</span> <span class="o">==</span> <span class="n">Bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="generic-dynamic-conversions">Generic dynamic conversions<a class="headerlink" href="#generic-dynamic-conversions" title="Permanent link">&para;</a></h3>
<p><code>Generic</code> dynamic conversions are supported out of the box. Also, contrary to registered conversions, partially specialized generics are allowed. </p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">serialization_schema</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">Priority</span> <span class="o">=</span> <span class="nb">int</span>


<span class="k">def</span> <span class="nf">sort_by_priority</span><span class="p">(</span><span class="n">values_with_priority</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">T</span><span class="p">,</span> <span class="n">Priority</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values_with_priority</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>


<span class="k">assert</span> <span class="n">serialize</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">conversions</span><span class="o">=</span><span class="n">sort_by_priority</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">serialization_schema</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Priority</span><span class="p">],</span> <span class="n">conversions</span><span class="o">=</span><span class="n">sort_by_priority</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="field-conversions">Field conversions<a class="headerlink" href="#field-conversions" title="Permanent link">&para;</a></h2>
<p>It is possible to register a conversion for a particular dataclass field using <code>conversion</code> metadata.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span>
<span class="kn">from</span> <span class="nn">apischema.metadata</span> <span class="kn">import</span> <span class="n">conversion</span>

<span class="c1"># Set UTC timezone for example</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
<span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>

<span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">Conversion</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">datetime</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">some_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">conversion</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">))</span>
    <span class="n">other_date</span><span class="p">:</span> <span class="n">datetime</span>


<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;some_date&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other_date&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-10-13&quot;</span><span class="p">})</span> <span class="o">==</span> <span class="n">Foo</span><span class="p">(</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">)))</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;some_date&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;other_date&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-10-13T00:00:00&quot;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It's possible to pass a conversion only for deserialization or only for serialization</p>
</div>
<h2 id="serialized-method-conversions">Serialized method conversions<a class="headerlink" href="#serialized-method-conversions" title="Permanent link">&para;</a></h2>
<p>Serialized method can also have dedicated conversions</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">serialized</span>

<span class="c1"># Set UTC timezone for example</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
<span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="nd">@serialized</span><span class="p">(</span><span class="n">conversions</span><span class="o">=</span><span class="n">to_timestamp</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">some_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;some_date&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</code></pre></div>

<h2 id="dataclass-model-automatic-conversion-fromto-dataclass">Dataclass model - automatic conversion from/to dataclass<a class="headerlink" href="#dataclass-model-automatic-conversion-fromto-dataclass" title="Permanent link">&para;</a></h2>
<p>Conversions are a powerful tool, which allows to support every type you need. If it is particularly well suited for scalar types (<code>datetime.datetime</code>, <code>bson.ObjectId</code>, etc.), it may seem a little bit complex for object types. In fact, the conversion would often be a simple mapping of fields between the type and a dataclass.</p>
<p>That's why <em>apischema</em> provides a shortcut for this case: <code>apischema.conversions.dataclass_model</code>; it allows to specify a dataclass which will be used as a typed model for a given class : each field of the dataclass will be mapped on the attributes of the class instances.
The function returns two <code>Conversion</code> object, one for deserialization and the other for serialization. They can then be registered with <code>serializer</code>/<code>deserializer</code>, or be used dynamically.</p>
<p>Remember that dataclass can also be declared dynamically with <code>dataclasses.make_dataclasses</code>. That's especially useful when it comes to add support for libraries like ORM. The following example show how to add a <a href="../examples/sqlalchemy_support/">basic support for 
<em>SQLAlchemy</em></a>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">field</span><span class="p">,</span> <span class="n">make_dataclass</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">graphql</span> <span class="kn">import</span> <span class="n">print_schema</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">as_declarative</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">deserializer</span><span class="p">,</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">serializer</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">dataclass_model</span>
<span class="kn">from</span> <span class="nn">apischema.graphql</span> <span class="kn">import</span> <span class="n">graphql_schema</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">serialization_schema</span>
<span class="kn">from</span> <span class="nn">apischema.metadata</span> <span class="kn">import</span> <span class="n">required</span>


<span class="k">def</span> <span class="nf">column_type</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="n">Column</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">col_type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">python_type</span>
    <span class="k">return</span> <span class="n">Optional</span><span class="p">[</span><span class="n">col_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="n">col_type</span>


<span class="k">def</span> <span class="nf">column_field</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="n">Column</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">column</span><span class="o">.</span><span class="n">default</span>
    <span class="k">elif</span> <span class="n">column</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Undefined</span>
    <span class="k">elif</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Put default everywhere to avoid</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">required</span><span class="p">)</span>


<span class="c1"># Very basic SQLAlchemy support</span>
<span class="nd">@as_declarative</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Column</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="n">column_field</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span>
        <span class="p">]</span>
        <span class="n">d_conv</span><span class="p">,</span> <span class="n">s_conv</span> <span class="o">=</span> <span class="n">dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fields</span><span class="p">))</span>
        <span class="n">deserializer</span><span class="p">(</span><span class="n">d_conv</span><span class="p">)</span>
        <span class="n">serializer</span><span class="p">(</span><span class="n">s_conv</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">baz</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="n">foo</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">bar</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<span class="k">assert</span> <span class="n">serialization_schema</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">},</span> <span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]}},</span>
    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">],</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">foos</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="n">Foo</span><span class="p">]]:</span>
    <span class="o">...</span>


<span class="n">schema</span> <span class="o">=</span> <span class="n">graphql_schema</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">[</span><span class="n">foos</span><span class="p">])</span>
<span class="n">schema_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">type Query {</span>
<span class="s2">  foos: [Foo!]</span>
<span class="s2">}</span>

<span class="s2">type Foo {</span>
<span class="s2">  bar: Int!</span>
<span class="s2">  baz: String</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="k">assert</span> <span class="n">print_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="o">==</span> <span class="n">schema_str</span>
</code></pre></div>

<p>There are two differences with regular conversions :</p>
<ul>
<li>The dataclass model computation can be deferred until it's needed. This is because some libraries do some resolutions after class definition (for example SQLAchemy resolves dynamic string references in relationships). So you could replace the following line in the example, it would works too.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># dataclass_model(cls)(make_dataclass(cls.__name__, fields))</span>
<span class="n">dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">)(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fields</span><span class="p">))</span>
</code></pre></div>

<ul>
<li><a href="../de_serialization/#serialized-methodsproperties">Serialized methods/properties</a> of the class are automatically added to the dataclass model (but you can also declare serialized methods in the dataclass model). This behavior can be toggled off using <code>fields_only</code> parameter with a <code>True</code> value. </li>
</ul>
<h2 id="function-parameters-as-dataclass">Function parameters as dataclass<a class="headerlink" href="#function-parameters-as-dataclass" title="Permanent link">&para;</a></h2>
<p><code>apischema.conversions.dataclass_input_wrapper</code> can convert a function into a new function taking a unique parameter, a dataclass whose fields are mapped from the original function parameters.</p>
<p>It can be used for example to build a deserialization conversion from an alternative constructor.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">alias</span><span class="p">,</span> <span class="n">deserialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">dataclass_input_wrapper</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">deserialization_schema</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># Annotated can be used to add metadata to mapped fields</span>
<span class="k">def</span> <span class="nf">prefixed_foo</span><span class="p">(</span><span class="n">baz</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pfx</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">alias</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Foo</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Foo</span><span class="p">(</span><span class="n">pfx</span> <span class="o">+</span> <span class="n">baz</span><span class="p">)</span>


<span class="n">wrapper</span><span class="p">,</span> <span class="n">input_cls</span> <span class="o">=</span> <span class="n">dataclass_input_wrapper</span><span class="p">(</span><span class="n">prefixed_foo</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">input_cls</span><span class="p">(</span><span class="s2">&quot;oo&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="n">prefixed_foo</span><span class="p">(</span><span class="s2">&quot;oo&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>

<span class="c1"># Used as conversion</span>
<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="s2">&quot;oo&quot;</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">},</span> <span class="n">conversions</span><span class="o">=</span><span class="n">wrapper</span><span class="p">)</span> <span class="o">==</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">deserialization_schema</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="n">conversions</span><span class="o">=</span><span class="n">wrapper</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;baz&quot;</span><span class="p">],</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Metadata can also be passed with <code>parameters_metadata</code> parameter; it takes a mapping of parameter names as key and mapped metadata as value.</p>
</div>
<h2 id="default-conversions">Default conversions<a class="headerlink" href="#default-conversions" title="Permanent link">&para;</a></h2>
<p>As almost every default behavior in <em>apischema</em>, default conversion can be configured using <code>apischema.settings.deserialization</code>/<code>apischema.settings.serialization</code>. The initial value of these settings are the function which retrieved conversions registered with <code>deserializer</code>/<code>serializer</code>.</p>
<p>You can for example <a href="../examples/attrs_support/">support <em>attrs</em></a> classes with this feature:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">MISSING</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">make_dataclass</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">attr</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">dataclass_model</span>
<span class="kn">from</span> <span class="nn">apischema.conversions.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">Conversions</span>


<span class="k">def</span> <span class="nf">attrs_to_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">default</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">attr</span><span class="o">.</span><span class="n">NOTHING</span> <span class="k">else</span> <span class="n">MISSING</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>


<span class="nd">@lru_cache</span><span class="p">()</span>  <span class="c1"># Use cache because it will be called often</span>
<span class="k">def</span> <span class="nf">attrs_dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Conversion</span><span class="p">,</span> <span class="n">Conversion</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs_to_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>


<span class="n">prev_deserialization</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">deserialization</span><span class="p">()</span>
<span class="n">prev_serialization</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">serialization</span><span class="p">()</span>


<span class="nd">@settings</span><span class="o">.</span><span class="n">deserialization</span>
<span class="k">def</span> <span class="nf">deserialization</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conversions</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">prev_deserialization</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">):</span>
        <span class="n">deserialization_conversion</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attrs_dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deserialization_conversion</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@settings</span><span class="o">.</span><span class="n">serialization</span>
<span class="k">def</span> <span class="nf">serialization</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conversions</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">prev_serialization</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">serialization_conversion</span> <span class="o">=</span> <span class="n">attrs_dataclass_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serialization_conversion</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>


<span class="k">assert</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span> <span class="o">==</span> <span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</code></pre></div>

<h2 id="sub-conversions">Sub-conversions<a class="headerlink" href="#sub-conversions" title="Permanent link">&para;</a></h2>
<p>Sub-conversions are <a href="#dynamic-conversions--select-conversions-at-runtime">dynamic conversions</a> applied on the result of a conversion.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span>
<span class="kn">from</span> <span class="nn">apischema.json_schema</span> <span class="kn">import</span> <span class="n">serialization_schema</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">query_to_list</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">Query</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">query_to_scalar</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">Query</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FooModel</span><span class="p">:</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FooModel</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">assert</span> <span class="n">serialization_schema</span><span class="p">(</span>
    <span class="n">Query</span><span class="p">[</span><span class="n">Foo</span><span class="p">],</span> <span class="n">conversions</span><span class="o">=</span><span class="n">Conversion</span><span class="p">(</span><span class="n">query_to_list</span><span class="p">,</span> <span class="n">sub_conversions</span><span class="o">=</span><span class="n">Foo</span><span class="o">.</span><span class="n">serialize</span><span class="p">)</span>
<span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
    <span class="c1"># We get an array of Foo</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">],</span>
        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft/2019-09/schema#&quot;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>Sub-conversions can also be used to <a href="#bypass-registered-conversion">bypass registered conversions</a> or to define <a href="#lazyrecursive-conversions">recursive conversions</a>.</p>
<h2 id="lazyrecursive-conversions">Lazy/recursive conversions<a class="headerlink" href="#lazyrecursive-conversions" title="Permanent link">&para;</a></h2>
<p>Conversions can be defined lazily, i.e. using a function returning <code>Conversion</code> (single, or a collection of it); this function must be wrap into a <code>apischema.conversions.LazyConversion</code> instance.</p>
<p>It allows creating recursive conversions or using a conversion object which can be modified after its definition (for example a conversion for a base class modified by <code>__init_subclass__</code>)</p>
<p>It is used by <em>apischema</em> itself for the generated JSON schema. It is indeed a recursive data, and the <a href="../json_schema/#json-schema--openapi-version">different versions</a> are handled by a conversion with a lazy recursive sub-conversion.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">apischema</span> <span class="kn">import</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">apischema.conversions</span> <span class="kn">import</span> <span class="n">Conversion</span><span class="p">,</span> <span class="n">LazyConversion</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;Foo&quot;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">foo_elements</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Foo</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="n">foo</span><span class="o">.</span><span class="n">elements</span>


<span class="c1"># Recursive conversion pattern</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">conversion</span> <span class="o">=</span> <span class="n">Conversion</span><span class="p">(</span><span class="n">foo_elements</span><span class="p">,</span> <span class="n">sub_conversions</span><span class="o">=</span><span class="n">LazyConversion</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">tmp</span><span class="p">))</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">conversion</span>

<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">Foo</span><span class="p">([</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">conversion</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="c1"># Without the recursive sub-conversion, it would have been:</span>
<span class="k">assert</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Foo</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">Foo</span><span class="p">([</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">conversions</span><span class="o">=</span><span class="n">foo_elements</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
</code></pre></div>

<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<h4 id="why-conversion-can-only-be-applied-on-classes">Why conversion can only be applied on classes?<a class="headerlink" href="#why-conversion-can-only-be-applied-on-classes" title="Permanent link">&para;</a></h4>
<p>Serialization doesn't have access to annotations (it's way less performant to use model annotations, and things like <code>Union</code> are useless in a serialization point of view), it uses instead the class of the object serialized; so <code>NewType</code> and other things that don't exist at runtime are simply unavailable.</p>
<p>Also, generic specialization like <code>Foo[int]</code> cannot be retrieved by serialization, that's why their registration is not allowed. </p>
<p>On the other hand, deserialization use annotations, so it could indeed apply conversions to other types (and it was in fact the case in the firsts versions).</p>
<p>However, it has been judged better to get the same restriction on both operation for simplicity and because the main need of deserialization customization is validation, which can already be registered for <code>NewType</code> or embedded in <code>Annotated</code>, etc.</p>
<h4 id="why-dynamic-conversion-cannot-apply-on-the-whole-data-model">Why dynamic conversion cannot apply on the whole data model?<a class="headerlink" href="#why-dynamic-conversion-cannot-apply-on-the-whole-data-model" title="Permanent link">&para;</a></h4>
<p>To keep <code>$ref</code> referencing the same schema between to endpoints with different dynamic conversions. If the conversion was global, one field of a class could be changed in a schema and not in the other, which would break the <code>$ref</code> principle.</p>
<p>Because it would break the concept of <code>$ref</code>, because the content of a <code>$ref</code> would be changed between two endpoints with different global conversions, as conversions could change the fields in one and not in the other. </p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../validation/" title="Validation" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Validation
              </div>
            </div>
          </a>
        
        
          <a href="../graphql/overview/" title="Overview" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Overview
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.92ffa368.min.js"></script>
      <script src="../assets/javascripts/bundle.5123e3d4.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>